<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>maker of application</title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="maker of application" />
<meta name="author" content="dengqinghua" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="运维 机器配置 4核8G" />
<meta property="og:description" content="运维 机器配置 4核8G" />
<link rel="canonical" href="https://dengqinghua.github.io/scratch-maker.html" />
<meta property="og:url" content="https://dengqinghua.github.io/scratch-maker.html" />
<meta property="og:site_name" content="Dengqinghua.42" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-23T00:00:00+08:00" />
<script type="application/ld+json">
{"url":"https://dengqinghua.github.io/scratch-maker.html","headline":"maker of application","dateModified":"2021-04-23T00:00:00+08:00","datePublished":"2021-04-23T00:00:00+08:00","author":{"@type":"Person","name":"dengqinghua"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dengqinghua.github.io/scratch-maker.html"},"description":"运维 机器配置 4核8G","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://dengqinghua.github.io/feed.xml" title="Dengqinghua.42" />

  <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="light">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">..</a>

<article>
  <p class="post-meta">
    <time datetime="2021-04-23 00:00:00 +0800">2021-04-23</time>
  </p>
  
  <h1>maker of application</h1>

  <ul id="toc" class="section-nav">
<li class="toc-entry toc-h3"><a href="#运维">运维</a>
<ul>
<li class="toc-entry toc-h4"><a href="#机器配置">机器配置</a></li>
<li class="toc-entry toc-h4"><a href="#用户配置">用户配置</a></li>
<li class="toc-entry toc-h4"><a href="#软件安装">软件安装</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#基础设施">基础设施</a>
<ul>
<li class="toc-entry toc-h4"><a href="#gitlab">gitlab</a></li>
<li class="toc-entry toc-h4"><a href="#其他">其他</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#中间件">中间件</a></li>
<li class="toc-entry toc-h3"><a href="#业务系统">业务系统</a></li>
</ul><h3 id="运维">
<a class="anchor" href="#%E8%BF%90%E7%BB%B4" aria-hidden="true"><span class="octicon octicon-link"></span></a>运维</h3>
<h4 id="机器配置">
<a class="anchor" href="#%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE" aria-hidden="true"><span class="octicon octicon-link"></span></a>机器配置</h4>
<p>4核8G</p>

<h4 id="用户配置">
<a class="anchor" href="#%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE" aria-hidden="true"><span class="octicon octicon-link"></span></a>用户配置</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo su -
useradd YouName
passwd YouName
visudo
YouName ALL=(ALL) NOPASSWD:ALL

# 设置通用的目录
mkdir -p /var/www/site
chmod -R 777 /var/www/site
</code></pre></div></div>

<h4 id="软件安装">
<a class="anchor" href="#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>软件安装</h4>
<p>安装 git, docker, docker-compose, jq, gitlab-runner, node, nginx</p>

<hr data-content=" git ">

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum remove git*
sudo yum -y install https://packages.endpoint.com/rhel/7/os/x86_64/endpoint-repo-1.7-1.x86_64.rpm
sudo yum install git
</code></pre></div></div>

<hr data-content=" gitlab-runner ">

<p><a href="https://docs.gitlab.com/runner/install/linux-repository.html">Ref</a></p>

<p>需要将 runner 加入到 root 中</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo usermod -aG root gitlab-runner
</code></pre></div></div>

<hr data-content=" node ">

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -sL https://rpm.nodesource.com/setup_12.x | sudo bash -lu
sudo yum install -y nodejs
</code></pre></div></div>

<hr data-content=" nginx ">

<p>静态文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen 80;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;

    server_name admin.exmaple.com;

    client_max_body_size 200M;

    root /var/www/site/admin_dev;
    location / {
      index index.html index.htm;
      try_files $uri /index.html;
    }

    gzip on;
    gzip_buffers 32 4K;
    gzip_comp_level 6;
    gzip_min_length 100;
    gzip_types application/javascript text/css text/xml;
    gzip_disable "MSIE [1-6]\.";
    gzip_vary on;
}
</code></pre></div></div>

<p>SSL</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen 443 ssl;

    server_name api0.exmaple.com;
    ## 这个文件需要放在 /etc/nginx 的目录下
    ssl_certificate 1_api0.exmaple.com_bundle.crt;
    ssl_certificate_key 2_api0.exmaple.com.key;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;

    client_max_body_size 100M;

    location / {
      proxy_pass http://127.0.0.1:8888;
    }
}
</code></pre></div></div>

<p>负载均衡</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upstream java_prod_server {
  server 127.0.0.1:8880;
  server 127.0.0.1:8881;
}
</code></pre></div></div>

<p>重定向</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  listen 80;

  server_name admin.exmaple.com;

  return 301 https://admin.exmaple.com$request_uri;
}
</code></pre></div></div>

<h3 id="基础设施">
<a class="anchor" href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD" aria-hidden="true"><span class="octicon octicon-link"></span></a>基础设施</h3>
<h4 id="gitlab">
<a class="anchor" href="#gitlab" aria-hidden="true"><span class="octicon octicon-link"></span></a>gitlab</h4>
<p><a href="https://github.com/jl-borges/docker-gitlab">Ref</a></p>

<p>需要更改的配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TZ=Asia/Shanghai
GITLAB_TIMEZONE=Asia/Shanghai
GITLAB_HOST=gitlab.youDomain.com

GITLAB_ROOT_PASSWORD=password!1234
GITLAB_ROOT_EMAIL=youEmail

SMTP_ENABLED=true
SMTP_DOMAIN=youDomain.com
SMTP_HOST=smtp.ym.163.com
SMTP_PORT=25
SMTP_USER=noreply@youDomain.com
SMTP_PASS=youDomainPsw
SMTP_STARTTLS=true
SMTP_TLS=false
SMTP_AUTHENTICATION=plain
</code></pre></div></div>

<p>下面是 CI 的配置例子</p>

<hr data-content=" java ">

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>variables:
  JAR_FOLDER: /var/www/site/java
stages:
  - build
  - stage-deploy
  - prod-deploy
cache:
  paths:
    - .m2
build:
  stage: build
  variables:
    BE_CONTAINER_TEMP: backend_service_container_temp
  script:
    - mkdir -p .m2
    - docker build -t backend_service . --rm
    ## 生成临时 docker
    - docker create -ti --name $BE_CONTAINER_TEMP backend_service bash
    ## 拷贝打包的文件到指定的目录下 XXX: 注意需要在这里有对应的权限 /var/www/site/java
    - docker cp $BE_CONTAINER_TEMP:/build/server/target/backend-server-1.0-SNAPSHOT.jar $JAR_FOLDER/app.jar
    - docker cp $BE_CONTAINER_TEMP:/build/deploy.sh $JAR_FOLDER/deploy
    ## 备份缓存, 在下次使用
    - docker cp $BE_CONTAINER_TEMP:/build/.m2/repository .m2
    ## 删除临时 docker
    - docker rm $BE_CONTAINER_TEMP
dev-deploy:
  stage: stage-deploy
  variables:
    PROFILE_ENV: dev
    PORTS: 8880
    ## FIXME: 这里的机器IP 用于 spring boot admin, 理论上应该使用服务发现的方式 而不是配置 IP
    CURRENT_MACHINE_IP: 172.21.x.7
  script:
    - cd $JAR_FOLDER
    - ./deploy

qa-deploy:
  stage: stage-deploy
  variables:
    PROFILE_ENV: test
    PORTS: 9990 9991
    ## FIXME: 这里的机器IP 用于 spring boot admin, 理论上应该使用服务发现的方式 而不是配置 IP
    CURRENT_MACHINE_IP: 172.21.x.7
  script:
    - cd $JAR_FOLDER
    - ./deploy

prod-deploy:
  tags:
    - prod
  stage: prod-deploy
  when: manual
  variables:
    BUILD_MACHINE_IP: 172.21.x.7
    PROFILE_ENV: prod
    PORTS: 8880 8881
    ## FIXME: 这里的机器IP 用于 spring boot admin, 理论上应该使用服务发现的方式 而不是配置 IP
    CURRENT_MACHINE_IP: 172.21.x.7
  script:
    - scp -Cr kxkq@$BUILD_MACHINE_IP:$JAR_FOLDER/app.jar $JAR_FOLDER
    - scp -Cr kxkq@$BUILD_MACHINE_IP:$JAR_FOLDER/deploy $JAR_FOLDER
    - cd $JAR_FOLDER
    - ./deploy
</code></pre></div></div>

<p>Dockerfile</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM maven:3.6.3-jdk-11-slim

WORKDIR /build
COPY ci_settings.xml .
COPY . /build
RUN mvn package -q -s ci_settings.xml -Dmaven.repo.local=/build/.m2/repository
</code></pre></div></div>

<p>ci_settings.xml</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
  https://maven.apache.org/xsd/settings-1.0.0.xsd"&gt;

  &lt;servers&gt;
    &lt;server&gt;
      &lt;!--这是server的id（注意不是用户登陆的id），该id与distributionManagement中repository元素的id相匹配。 --&gt;
      &lt;id&gt;nexus&lt;/id&gt;
      &lt;username&gt;Youname&lt;/username&gt;
      &lt;password&gt;Youpassword&lt;/password&gt;
    &lt;/server&gt;
  &lt;/servers&gt;

  &lt;!--为仓库列表配置的下载镜像列表。  --&gt;
  &lt;mirrors&gt;
    &lt;mirror&gt;
      &lt;!--该镜像的唯一标识符。id用来区分不同的mirror元素。  --&gt;
      &lt;id&gt;nexus&lt;/id&gt;
      &lt;!--此处配置所有的构建均从私有仓库中下载 *代表所有，也可以写central --&gt;
      &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
      &lt;name&gt;central repository&lt;/name&gt;
      &lt;!--该镜像的URL。构建系统会优先考虑使用该URL，而非使用默认的服务器URL。  --&gt;
      &lt;url&gt;http://maven.youDomain.com/repository/maven-public/&lt;/url&gt;
    &lt;/mirror&gt;
  &lt;/mirrors&gt;

  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;nexus&lt;/id&gt;
      &lt;!--远程仓库列表，它是Maven用来填充构建系统本地仓库所使用的一组远程项目。  --&gt;
      &lt;repositories&gt;
        &lt;!--发布版本仓库--&gt;
        &lt;repository&gt;
          &lt;id&gt;nexus&lt;/id&gt;
          &lt;!--地址是nexus中repository（Releases/Snapshots）中对应的地址--&gt;
          &lt;url&gt;http://maven.youDomain.com/repository/maven-public/&lt;/url&gt;
          &lt;!--true或者false表示该仓库是否为下载某种类型构件（发布版，快照版）开启。 --&gt;
          &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;/releases&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;/snapshots&gt;
        &lt;/repository&gt;
      &lt;/repositories&gt;

      &lt;!-- 定义所有可能用到的插件仓库 --&gt;
      &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
          &lt;id&gt;aliyun-central&lt;/id&gt;
          &lt;url&gt;http://maven.aliyun.com/repository/central&lt;/url&gt;
        &lt;/pluginRepository&gt;
      &lt;/pluginRepositories&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;

  &lt;!--激活配置--&gt;
  &lt;activeProfiles&gt;
    &lt;!--profile下的id--&gt;
    &lt;activeProfile&gt;nexus&lt;/activeProfile&gt;
  &lt;/activeProfiles&gt;
&lt;/settings&gt;
</code></pre></div></div>

<p>deploy.sh</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ -z "$PORTS" ] &amp;&amp; echo "PORT not defined" &amp;&amp; exit 1
[ -z "$CURRENT_MACHINE_IP" ] &amp;&amp; echo "CURRENT_MACHINE_IP not defined"
[ -z "$PROFILE_ENV" ] &amp;&amp; echo "PROFILE_ENV not defined" &amp;&amp; exit 1
[ -z "$JAR_FOLDER" ] &amp;&amp; echo "JAR_FOLDER not defined, set to /var/www/site/java" &amp;&amp; JAR_FOLDER=/var/www/site/java

## 根据环境不同, 输出日志目录: /var/www/site/java/dev_backend_service.log
APP_NAME=${PROFILE_ENV}_backend_service;
TIMEOUT=60
JAVA_OPTION="-Xmx2g -Xms256m"

for PORT in $PORTS
  do
    CONTAINER_NAME=${APP_NAME}_${PORT};
    if [ "$(docker ps -aq -f status=running -f name="$CONTAINER_NAME")" ]
      then docker stop "$CONTAINER_NAME";
    fi
    sleep 0.5
    echo "Begin to run SpringApp: JAVA_OPTION: $JAVA_OPTION, profile: $PROFILE_ENV, port: $PORT, machineIP: $CURRENT_MACHINE_IP"
    ## 在启动的时候，配置了 spring boot admin 的监控的相关监控
    docker run -d \
      -p "${PORT}":8080 --rm \
      -v "$JAR_FOLDER"/app.jar:/app.jar \
      --name "$CONTAINER_NAME" \
      --env TZ=GMT+8 \
      --env SPRING_PROFILES_ACTIVE="$PROFILE_ENV" \
      --env spring.application.name="$APP_NAME"\
      --env spring.boot.admin.client.enabled=true\
      --env spring.boot.admin.client.instance.service-base-url="http://$CURRENT_MACHINE_IP:$PORT" \
      openjdk:11 \
      java -jar /app.jar "$JAVA_OPTION"

    READY=DOWN
    i=1
    until [ "$READY" == "UP" ]
    do
      ## XXX: 注意，这里需要安装 jq 这个软件, 用来解析 JSON, 否则会导致报错
      READY=$(curl --silent --fail 127.0.0.1:"${PORT}"/actuator/health | jq -r '.status.code')
      sleep 1;
      echo "SpringApp is starting... at ${i}s";
      ((i++))
      ## 默认设置 1分钟 超时, 如果在 1分钟 还未启动成功, 则认为服务无法启动
      if [[ "$i" == "$TIMEOUT" ]]; then
        echo "Timeout over ${TIMEOUT}s..."
        exit 1
      fi
    done
    echo 'SpringApp started';
    docker logs -f "$CONTAINER_NAME" &gt;&gt; $JAR_FOLDER/"$APP_NAME".log 2&gt;&amp;1 &amp;
  done
</code></pre></div></div>

<hr data-content=" node ">

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stages:
  - qa-build
  - prod-build
  - dev-build
  - prod-deploy
variables:
  ## 这个是打包的机器, 为 线上的 qa 环境的机器
  BUILD_MACHINE_IP: 172.21.16.10
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
qa-build:
  stage: qa-build
  tags:
    - adminBuild
  script:
    - npm install --registry=https://registry.npm.taobao.org
    - npm run build:qa
    - mkdir -p /var/www/site/admin_qa
    - cp -rf $PWD/dist/** /var/www/site/admin_qa
dev-build:
  stage: dev-build
  tags:
    - adminBuild
  script:
    - npm install --registry=https://registry.npm.taobao.org
    - npm run build:dev
    - mkdir -p /var/www/site/admin_dev
    - cp -rf $PWD/dist/** /var/www/site/admin_dev
prod-build:
  stage: prod-build
  tags:
    - adminBuild
  script:
    - npm install --registry=https://registry.npm.taobao.org
    - npm run build:prod
    - mkdir -p /var/www/site/admin_prod
    - cp -rf $PWD/dist/** /var/www/site/admin_prod
prod-deploy:
  tags:
    - prod
  stage: prod-deploy
  when: manual
  script:
    - scp -Cr kxkq@$BUILD_MACHINE_IP:/var/www/site/admin_prod /var/www/site/
</code></pre></div></div>

<h4 id="其他">
<a class="anchor" href="#%E5%85%B6%E4%BB%96" aria-hidden="true"><span class="octicon octicon-link"></span></a>其他</h4>

<ul>
  <li>
    <p><a href="https://github.com/jl-borges/maker/blob/main/maven/docker-compose.yml">Maven</a></p>

    <p>注: 密码需要到 /nexus-data/admin.password 里面去查看</p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/docker-reviewboard">Reviewboard</a></p>

    <p>注: 这里不能调用 docker-compose down, 该部分会删除记录… 重启的话, 执行 docker-compose restart</p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/spring-boot-admin">Spring boot admin</a></p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/baota?organization=jl-borges&amp;organization=jl-borges">宝塔</a></p>
  </li>
</ul>

<h3 id="中间件">
<a class="anchor" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6" aria-hidden="true"><span class="octicon octicon-link"></span></a>中间件</h3>
<ul>
  <li><a href="https://github.com/jl-borges/maker/blob/main/mysql/docker-compose.yml">MySQL</a></li>
  <li><a href="https://github.com/jl-borges/maker/blob/main/redis/docker-compose.yml">Redis</a></li>
  <li>Kafak, TODO</li>
  <li>ES, TODO</li>
</ul>

<h3 id="业务系统">
<a class="anchor" href="#%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F" aria-hidden="true"><span class="octicon octicon-link"></span></a>业务系统</h3>
<ul>
  <li>Java, see legacy</li>
  <li>Antd-React, see legacy</li>
</ul>

</article>

      </div>
    </main>

    
  </body>
</html>